<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JLN MANAGEMEN SYSTEM</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .sidebar-active { background-color: #3b82f6; color: white; }
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.8); z-index: 9999;
      display: flex; align-items: center; justify-content: center;
    }
    .hidden { display: none !important; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: #f3f4f6; }
    #mapPicker { height: 420px; border-radius: 14px; }
  </style>
</head>

<body>

  <!-- LOADING OVERLAY -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      <p class="mt-3 text-blue-600 font-medium" id="loadingText">Memproses...</p>
    </div>
  </div>

  <!-- UNIVERSAL MODAL FORM -->
  <div id="modalForm" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 flex flex-col max-h-[90vh]">
      <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
        <h3 class="font-bold text-lg text-gray-800" id="modalTitle">Form Input</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i data-lucide="x"></i></button>
      </div>
      <div class="p-6 overflow-y-auto custom-scrollbar">
        <form id="dynamicForm" onsubmit="handleFormSubmit(event)" class="space-y-4"></form>
      </div>
      <div class="p-5 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
        <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-200">Batal</button>
        <button type="submit" form="dynamicForm" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">Simpan Data</button>
      </div>
    </div>
  </div>

  <!-- MAP PICKER MODAL (SATELLITE) -->
  <div id="mapPickerModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl mx-4 flex flex-col max-h-[92vh]">
      <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
        <div>
          <h3 class="font-bold text-lg text-gray-800">Pilih Koordinat (Mode Satelit)</h3>
          <p class="text-xs text-gray-500">Klik peta untuk memindahkan pin, atau drag pin. Lalu klik Gunakan.</p>
        </div>
        <button onclick="closeMapPicker()" class="text-gray-400 hover:text-red-500"><i data-lucide="x"></i></button>
      </div>

      <div class="p-5 space-y-3 overflow-y-auto custom-scrollbar">
        <div class="flex flex-col md:flex-row gap-2">
          <input id="mapSearchInput" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cari lokasi (contoh: nama desa / masjid / jalan)">
          <button type="button" onclick="searchOnMap()" class="px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800">Cari</button>
          <button type="button" onclick="useMyLocation()" class="px-4 py-2 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 font-medium">Lokasi Saya</button>
        </div>

        <div id="mapPicker" class="border"></div>

        <div class="text-sm">
          <div class="font-medium text-gray-700">Terpilih:</div>
          <div class="text-gray-600" id="mapPickedText">-</div>
          <div class="mt-1">
            <a id="mapOpenGmaps" href="#" target="_blank" class="text-blue-600 hover:underline text-xs hidden">Buka di Google Maps</a>
          </div>
        </div>
      </div>

      <div class="p-5 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
        <button type="button" onclick="closeMapPicker()" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-200">Batal</button>
        <button type="button" onclick="applyPickedCoords()" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">Gunakan</button>
      </div>
    </div>
  </div>

  <!-- APP CONTAINER -->
  <div id="app" class="min-h-screen flex flex-col">

    <!-- LOGIN VIEW -->
    <div id="loginView" class="flex-1 flex items-center justify-center p-4">
      <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <div class="text-center mb-8">
          <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="activity" class="text-blue-600 w-8 h-8"></i>
          </div>
          <h1 class="text-2xl font-bold text-gray-800">JLN MANAGEMEN</h1>
          <p class="text-gray-500">Sistem Informasi Management</p>
        </div>

        <div id="previewBadge" class="bg-amber-50 border border-amber-200 p-3 rounded-lg mb-6 hidden">
          <p class="text-xs text-amber-700 font-bold">MODE PREVIEW</p>
          <p class="text-xs text-amber-600">Admin: <b>admin</b> | Pass: <b>Admin2024!</b></p>
        </div>

        <form onsubmit="handleLogin(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Username / No. Internet</label>
            <input type="text" id="loginUsername" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input type="password" id="loginPassword" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
          </div>

          <button type="submit" id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition-all duration-300">
            Login System
          </button>

          <div class="text-center mt-4">
            <p class="text-xs text-gray-400">Silakan login menggunakan akun yang diberikan Admin.</p>
          </div>
        </form>
      </div>
    </div>

    <!-- MAIN VIEW -->
    <div id="mainView" class="hidden flex flex-1 overflow-hidden h-screen">
      <!-- Sidebar -->
      <aside id="sidebar" class="bg-white w-64 border-r flex-shrink-0 flex flex-col transition-all duration-300 transform -translate-x-full md:translate-x-0 absolute md:relative z-40 h-full shadow-lg md:shadow-none">
        <div class="p-6 border-b flex items-center justify-between">
          <span class="font-bold text-xl text-blue-600 flex items-center gap-2">
            <i data-lucide="network"></i> JLN MGR
          </span>
          <button class="md:hidden" onclick="toggleSidebar()"><i data-lucide="x"></i></button>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar" id="navLinks"></nav>

        <div class="p-4 border-t bg-gray-50">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold" id="userInitial">A</div>
            <div class="overflow-hidden">
              <p class="text-sm font-bold truncate" id="userNameDisplay">Loading...</p>
              <p class="text-xs text-gray-500" id="userRoleDisplay">Role</p>
            </div>
          </div>
          <button onclick="logout()" class="w-full text-left px-4 py-2 rounded-lg hover:bg-red-50 text-red-600 flex items-center gap-2">
            <i data-lucide="log-out" class="w-4 h-4"></i> Keluar
          </button>
        </div>
      </aside>

      <!-- Content Area -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b p-4 flex items-center justify-between">
          <button class="md:hidden" onclick="toggleSidebar()"><i data-lucide="menu"></i></button>
          <h2 class="font-bold text-lg text-gray-800" id="pageTitle">Dashboard</h2>
          <div class="flex items-center gap-2">
            <span class="text-xs px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold">LIVE</span>
          </div>
        </header>

        <!-- Dynamic Content -->
        <section class="flex-1 overflow-y-auto p-6 custom-scrollbar" id="contentArea"></section>
      </main>
    </div>
  </div>

<script>
/* ===========================
   GUARD
=========================== */
window.addEventListener('error', function(e){
  console.error('JS Error:', e.error || e.message);
  try { Swal.fire('Error JS', String(e.message || e.error || 'Unknown'), 'error'); } catch(_) {}
});
window.addEventListener('unhandledrejection', function(e){
  console.error('Promise Error:', e.reason);
  try { Swal.fire('Error Promise', String(e.reason || 'Unknown'), 'error'); } catch(_) {}
});

/* ===========================
   STATE
=========================== */
var currentUser = null;
var isPreview = false;
var authToken = null;

var refData = { packages: [], sales: [], locations: [], teknisi: [], customers: [] };

var currentEditId = null;
var globalTableData = [];
var globalTableConfig = null;

// table state + extra filter
var tableState = { search:'', filterStatus:'', sortKey:'', sortDir:'asc', extraKey:'', extraVal:'' };

// MOCK DB (preview)
var mockDB = {
  users: [
    {id:'1', username:'admin', password:'Admin2024!', nama:'Super Admin', email:'admin@example.com', role:'Admin', telp:'081234', alamat:'Server Room', created_at:'-'},
    {id:'2', username:'sales1', password:'123', nama:'Sales A', email:'sales@gmail.com', role:'Sales', telp:'08222', alamat:'-', created_at:'-'},
    {id:'3', username:'tek1', password:'123', nama:'Teknisi A', email:'tek@gmail.com', role:'Teknisi', telp:'08333', alamat:'-', created_at:'-'}
  ],
  packages: [
    {id:'p1', nama_paket:'Paket 10Mbps', harga:'150000', bandwidth:'10 Mbps', status_aktif:'Aktif', ketersediaan:'Tersedia', created_at:'-'}
  ],
  locations: [
    {id:'l1', nama_blok:'Blok A', keterangan:'Dekat Masjid', created_at:'-'}
  ],
  customers: [
    {id:'c1', nama:'Budi Santoso', username:'10001', password:'123', alamat:'Jl. Mawar No 1', lat:'-6.200000', lng:'106.816666', paket_id:'p1', lokasi_id:'l1', sales_id:'2', status:'Aktif', telp:'08567', foto_ktp:'', foto_rumah:'', catatan:'-', created_at:'-'}
  ],
  tickets: [],
  announcements: [],
  tutorials: [],
  reports: [],
  ticket_logs: [] // PATCH A
};

/* ===========================
   UTIL UI
=========================== */
function startLoading(text){
  document.getElementById('loadingText').textContent = text || 'Memproses...';
  document.getElementById('loadingOverlay').classList.remove('hidden');
}
function endLoading(){
  document.getElementById('loadingOverlay').classList.add('hidden');
}

function escapeHtml(s){
  return String(s === undefined || s === null ? '' : s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function truthy(v){
  var s = String(v === undefined || v === null ? '' : v).trim().toLowerCase();
  return ['1','true','ya','yes','y'].indexOf(s) !== -1;
}

function getById(arr, id){
  id = String(id || '');
  return (arr || []).find(function(x){ return String(x.id) === id; }) || null;
}

function fmtMoney(val){
  var n = parseInt(val || 0, 10);
  if (isNaN(n)) n = 0;
  return 'Rp ' + n.toLocaleString('id-ID');
}

/* ✅ PATCH: badge tidak pakai class tailwind dinamis */
function badge(val){
  var v = String(val || '-').trim();
  var cls = 'bg-gray-100 text-gray-700';
  if (['Aktif','Selesai','Tersedia'].includes(v)) cls = 'bg-green-100 text-green-700';
  if (['Open','Isolir','Tidak Tersedia','Non-Aktif'].includes(v)) cls = 'bg-red-100 text-red-700';
  if (['Proses','Antrian'].includes(v)) cls = 'bg-blue-100 text-blue-700';
  return '<span class="px-2 py-1 rounded-full text-xs font-bold '+cls+'">' + escapeHtml(v) + '</span>';
}

/* ✅ PATCH: normalisasi response getSheetData agar selalu array */
function normalizeSheetDataResponse(res){
  if (Array.isArray(res)) return res;
  if (res && typeof res === 'object' && Array.isArray(res.data)) return res.data;
  return [];
}

/* ======================================================
   PATCH PRIORITAS 1: WAJIB GANTI PASSWORD (SweetAlert)
====================================================== */
function showForceChangePassword(doneCb){
  if (isPreview){
    Swal.fire('Info', 'Mode Preview: fitur ganti password tidak dijalankan.', 'info');
    if (doneCb) doneCb();
    return;
  }
  if (!authToken){
    Swal.fire('Sesi', 'Token tidak ditemukan. Silakan login ulang.', 'info');
    logout(true);
    return;
  }

  Swal.fire({
    title: 'Wajib Ganti Password',
    html:
      '<div class="text-left">' +
        '<p class="text-sm text-gray-600 mb-3">Akun ini masih memakai password awal dari Admin. Silakan ganti password terlebih dahulu.</p>' +
        '<label class="text-xs text-gray-500">Password Lama</label>' +
        '<input id="cpOld" type="password" class="swal2-input" placeholder="Password lama" style="margin-top:6px;">' +
        '<label class="text-xs text-gray-500">Password Baru</label>' +
        '<input id="cpNew" type="password" class="swal2-input" placeholder="Minimal 6 karakter" style="margin-top:6px;">' +
        '<label class="text-xs text-gray-500">Ulangi Password Baru</label>' +
        '<input id="cpNew2" type="password" class="swal2-input" placeholder="Ulangi password baru" style="margin-top:6px;">' +
      '</div>',
    icon: 'warning',
    confirmButtonText: 'Simpan Password Baru',
    allowOutsideClick: false,
    allowEscapeKey: false,
    showCancelButton: false,
    preConfirm: function(){
      var oldP = (document.getElementById('cpOld').value || '').trim();
      var newP = (document.getElementById('cpNew').value || '').trim();
      var newP2 = (document.getElementById('cpNew2').value || '').trim();

      if (!oldP || !newP || !newP2) {
        Swal.showValidationMessage('Semua kolom wajib diisi.');
        return false;
      }
      if (newP.length < 6) {
        Swal.showValidationMessage('Password baru minimal 6 karakter.');
        return false;
      }
      if (newP !== newP2) {
        Swal.showValidationMessage('Ulangi password baru tidak sama.');
        return false;
      }
      if (newP === oldP) {
        Swal.showValidationMessage('Password baru tidak boleh sama dengan password lama.');
        return false;
      }

      // return promise: panggil server
      return new Promise(function(resolve, reject){
        google.script.run
          .withSuccessHandler(function(res){
            if (res && res.success){
              resolve(true);
            } else {
              reject((res && res.message) ? res.message : 'Gagal mengubah password.');
            }
          })
          .withFailureHandler(function(err){
            reject(String(err));
          })
          .changeOwnPassword(authToken, oldP, newP);
      }).catch(function(errMsg){
        Swal.showValidationMessage(String(errMsg || 'Gagal mengubah password.'));
        return false;
      });
    }
  }).then(function(result){
    if (result.isConfirmed){
      // tandai di client juga
      if (currentUser) currentUser.must_change_password = '';
      Swal.fire('Berhasil', 'Password berhasil diganti. Silakan lanjut.', 'success')
        .then(function(){
          if (doneCb) doneCb();
        });
    }
  });
}

/* ===========================
   AUTH RUNNER (TOKEN) - PATCH
=========================== */
function runAuth(fnName, args, onSuccess, onFail){
  if (isPreview){
    if (onFail) onFail('PREVIEW_MODE');
    return;
  }
  args = args || [];
  if (!authToken){
    if (onFail) onFail('TOKEN_MISSING');
    return;
  }

  var runner = google.script.run
    .withSuccessHandler(function(res){
      // Session expired check
      if (res && res.message && (res.message === 'SESSION_EXPIRED' || res.message === 'TOKEN_MISSING')){
        Swal.fire('Sesi Habis', 'Silakan login ulang.', 'info').then(function(){ logout(true); });
        return;
      }

      // ✅ kalau server balikin {success:false,...} jangan diteruskan ke UI
      if (res && typeof res === 'object' && res.success === false){
        if (onFail) onFail(res.message || 'Gagal memproses permintaan.');
        else Swal.fire('Gagal', (res.message || 'Gagal memproses permintaan.'), 'error');
        return;
      }

      if (onSuccess) onSuccess(res);
    })
    .withFailureHandler(function(err){
      if (String(err).indexOf('SESSION_EXPIRED') !== -1){
        Swal.fire('Sesi Habis', 'Silakan login ulang.', 'info').then(function(){ logout(true); });
        return;
      }
      if (onFail) onFail(err);
    });

  var callArgs = [authToken].concat(args);
  if (!runner[fnName]) {
    if (onFail) onFail('Function tidak ditemukan di server: ' + fnName);
    return;
  }
  runner[fnName].apply(runner, callArgs);
}

/* ===========================
   INIT
=========================== */
window.addEventListener('load', function(){
  lucide.createIcons();
  isPreview = !(window.google && google.script && google.script.run);

  if (isPreview){
    document.getElementById('previewBadge').classList.remove('hidden');
  } else {
    // Optional: restore session token (kalau masih valid)
    var saved = sessionStorage.getItem('JLN_TOKEN');
    if (saved){
      authToken = saved;
      startLoading('Memulihkan sesi...');
      google.script.run
        .withSuccessHandler(function(res){
          endLoading();
          if (res && res.success && res.session && res.session.user){
            currentUser = res.session.user;

            // PATCH: kalau masih wajib ganti password -> paksa sebelum masuk app
            var must = truthy(currentUser.must_change_password);
            if (must){
              showForceChangePassword(function(){
                afterLogin();
              });
            } else {
              afterLogin();
            }
          } else {
            authToken = null;
            sessionStorage.removeItem('JLN_TOKEN');
          }
        })
        .withFailureHandler(function(){
          endLoading();
          authToken = null;
          sessionStorage.removeItem('JLN_TOKEN');
        })
        .getSession(saved);
    }
  }
});

/* ===========================
   AUTH UI + PERMISSION HELPERS
=========================== */
function canAddRow(tableName){
  if (currentUser && currentUser.role === 'Admin') return true;
  if (currentUser && currentUser.role === 'Sales' && tableName === 'customers') return true;
  if (currentUser && currentUser.role === 'Pelanggan' && tableName === 'tickets') return true;
  return false;
}
function canEditRow(tableName, item){
  if (currentUser && currentUser.role === 'Admin') return true;
  if (currentUser && currentUser.role === 'Sales' && tableName === 'customers') return true;
  if (currentUser && currentUser.role === 'Teknisi' && tableName === 'tickets') return true;
  return false;
}
function canDeleteRow(tableName, item){
  if (currentUser && currentUser.role === 'Admin') return true;
  if (currentUser && currentUser.role === 'Sales' && tableName === 'customers') return true;
  return false;
}

/* ===========================
   AUTH
=========================== */
function handleLogin(e){
  e.preventDefault();
  var username = document.getElementById('loginUsername').value.trim();
  var password = document.getElementById('loginPassword').value.trim();

  startLoading('Login...');

  if (isPreview){
    var u = (mockDB.users.find(function(x){return x.username===username && x.password===password;}))
          || (mockDB.customers.find(function(x){return x.username===username && x.password===password;}));
    if (u){
      currentUser = Object.assign({}, u);
      if (!currentUser.role) currentUser.role = 'Pelanggan';
      authToken = 'preview-token';
      endLoading();
      afterLogin();
    } else {
      endLoading();
      Swal.fire('Gagal', 'Username atau Password salah!', 'error');
    }
    return;
  }

  google.script.run
    .withSuccessHandler(function(res){
      endLoading();
      if (res && res.success){
        currentUser = res.user;
        authToken = res.token;
        sessionStorage.setItem('JLN_TOKEN', authToken);

        // PATCH: Wajib ganti password untuk user baru
        var must = !!res.mustChangePassword || truthy(currentUser.must_change_password);
        if (must){
          showForceChangePassword(function(){
            afterLogin();
          });
        } else {
          afterLogin();
        }
      } else {
        Swal.fire('Gagal', (res && res.message) ? res.message : 'Login gagal', 'error');
      }
    })
    .withFailureHandler(function(err){
      endLoading();
      Swal.fire('Error', String(err), 'error');
    })
    .loginUser({username: username, password: password});
}

function afterLogin(){
  document.getElementById('loginView').classList.add('hidden');
  document.getElementById('mainView').classList.remove('hidden');

  document.getElementById('userNameDisplay').textContent = currentUser.nama || currentUser.username;
  document.getElementById('userRoleDisplay').textContent = currentUser.role || 'Role';
  document.getElementById('userInitial').textContent = (currentUser.nama || 'A').substring(0,1).toUpperCase();

  buildNav();
  renderDashboard();
  loadReferenceData(function(){ refreshDashboardStats(); });
}

function logout(silent){
  var _do = function(){
    currentUser = null;
    authToken = null;
    sessionStorage.removeItem('JLN_TOKEN');
    document.getElementById('mainView').classList.add('hidden');
    document.getElementById('loginView').classList.remove('hidden');
  };

  if (isPreview){
    _do();
    return;
  }
  if (!authToken){
    _do();
    return;
  }

  google.script.run
    .withSuccessHandler(function(){
      _do();
      if (!silent) Swal.fire('Info', 'Logout berhasil.', 'success');
    })
    .withFailureHandler(function(){
      _do();
      if (!silent) Swal.fire('Info', 'Logout berhasil.', 'success');
    })
    .logoutSession(authToken);
}

/* ===========================
   NAV & VIEW
=========================== */
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('-translate-x-full');
}

function buildNav(){
  var nav = document.getElementById('navLinks');
  nav.innerHTML = '';

  var menusAdmin = [
    { id: 'Dashboard', icon:'layout-dashboard', table:null },
    { id: 'Pelanggan', icon:'users', table:'customers' },
    { id: 'Paket', icon:'package', table:'packages' },
    { id: 'Lokasi', icon:'map-pin', table:'locations' },
    { id: 'Users', icon:'user-cog', table:'users' },
    { id: 'Tiket', icon:'tickets', table:'tickets' },
    { id: 'Pengumuman', icon:'megaphone', table:'announcements' },
    { id: 'Tutorial', icon:'video', table:'tutorials' },
    { id: 'Laporan', icon:'file-text', table:'reports' }
  ];

  var menusSales = [
    { id: 'Dashboard', icon:'layout-dashboard', table:null },
    { id: 'Pelanggan', icon:'users', table:'customers' }
  ];

  var menusTek = [
    { id: 'Dashboard', icon:'layout-dashboard', table:null },
    { id: 'Tiket', icon:'tickets', table:'tickets' }
  ];

  var menusCust = [
    { id: 'Dashboard', icon:'layout-dashboard', table:null },
    { id: 'Tiket', icon:'tickets', table:'tickets' },
    { id: 'Pengumuman', icon:'megaphone', table:'announcements' },
    { id: 'Tutorial', icon:'video', table:'tutorials' }
  ];

  var menus = menusAdmin;
  if (currentUser.role === 'Sales') menus = menusSales;
  if (currentUser.role === 'Teknisi') menus = menusTek;
  if (currentUser.role === 'Pelanggan') menus = menusCust;

  menus.forEach(function(m){
    var btn = document.createElement('button');
    btn.className = 'w-full flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-blue-50 text-gray-700 transition';
    btn.innerHTML = '<i data-lucide="'+m.icon+'" class="w-4 h-4"></i><span class="font-medium">'+m.id+'</span>';
    btn.onclick = function(){
      Array.prototype.forEach.call(document.querySelectorAll('#navLinks button'), function(b){
        b.classList.remove('sidebar-active');
      });
      btn.classList.add('sidebar-active');
      document.getElementById('pageTitle').textContent = m.id;

      if (m.id === 'Dashboard') renderDashboard();
      else renderTable(m.table, m.id);

      if (window.innerWidth < 768) toggleSidebar();
    };
    nav.appendChild(btn);
  });

  var first = nav.querySelector('button');
  if (first) first.classList.add('sidebar-active');
  lucide.createIcons();
}

/* ===========================
   DATA LOADER
=========================== */
function loadReferenceData(cb){
  if (isPreview){
    refData.packages = mockDB.packages;
    refData.sales = mockDB.users.filter(function(u){return u.role === 'Sales';});
    refData.teknisi = mockDB.users.filter(function(u){return u.role === 'Teknisi';});
    refData.locations = mockDB.locations;
    refData.customers = mockDB.customers;
    if (cb) cb();
    return;
  }

  runAuth('getReferenceData', [], function(res){
    refData = res || refData;
    if (cb) cb();
  }, function(err){
    Swal.fire('Error', 'Gagal load reference data: ' + err, 'error');
    if (cb) cb();
  });
}

/* ===========================
   DASHBOARD
=========================== */
function renderDashboard(){
  document.getElementById('contentArea').innerHTML =
    '<div class="grid grid-cols-1 md:grid-cols-5 gap-4">' +
      '<div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-sm text-gray-500">Pelanggan</p><p class="text-2xl font-bold" id="statCustomers">0</p></div>' +
      '<div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-sm text-gray-500">Paket</p><p class="text-2xl font-bold" id="statPackages">0</p></div>' +
      '<div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-sm text-gray-500">Tiket Aktif</p><p class="text-2xl font-bold" id="statTickets">0</p></div>' +
      '<div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-sm text-gray-500">Sales</p><p class="text-2xl font-bold" id="statSales">0</p></div>' +
      '<div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-sm text-gray-500">Total Income</p><p class="text-2xl font-bold" id="statIncome">Rp 0</p></div>' +
    '</div>' +
    '<div class="mt-6 bg-white p-6 rounded-2xl shadow-sm border">' +
      '<h3 class="font-bold text-gray-800 mb-2">Info</h3>' +
      '<p class="text-sm text-gray-600">Sistem berjalan LIVE melalui Google Spreadsheet. Koordinat pelanggan bisa dipilih lewat peta satelit saat input pelanggan. Tiket sekarang punya timeline (log) + chat/lampiran.</p>' +
    '</div>';
}

function refreshDashboardStats(){
  if (isPreview){
    document.getElementById('statCustomers').textContent = mockDB.customers.length;
    document.getElementById('statPackages').textContent = mockDB.packages.length;
    document.getElementById('statTickets').textContent = mockDB.tickets.length;
    document.getElementById('statSales').textContent = mockDB.users.filter(function(u){return u.role==='Sales';}).length;
    document.getElementById('statIncome').textContent = 'Rp 0';
    return;
  }

  runAuth('getDashboardStats', [], function(res){
    if (!res || !res.success) return;
    document.getElementById('statCustomers').textContent = res.customers;
    document.getElementById('statPackages').textContent = res.packages;
    document.getElementById('statTickets').textContent = res.tickets;
    document.getElementById('statSales').textContent = res.sales;
    document.getElementById('statIncome').textContent = 'Rp ' + (res.income || 0).toLocaleString('id-ID');
  }, function(){});
}

/* ===========================
   TABLE CONFIG PER MENU
=========================== */
function getExtraFilterConfig(tableName){
  if (tableName === 'customers'){
    var opts = [{val:'', txt:'Semua Paket'}].concat((refData.packages||[]).map(function(p){
      return {val:p.id, txt:p.nama_paket};
    }));
    return { key:'paket_id', label:'Filter Paket', options: opts };
  }

  if (tableName === 'tickets'){
    var opts2 = [{val:'', txt:'Semua Teknisi'}].concat((refData.teknisi||[]).map(function(t){
      return {val:t.id, txt:t.nama};
    }));
    return { key:'teknisi_id', label:'Filter Teknisi', options: opts2 };
  }

  if (tableName === 'users'){
    return { key:'role', label:'Filter Role', options:[
      {val:'', txt:'Semua Role'},
      {val:'Admin', txt:'Admin'},
      {val:'Sales', txt:'Sales'},
      {val:'Teknisi', txt:'Teknisi'}
    ]};
  }

  if (tableName === 'announcements'){
    return { key:'target', label:'Filter Target', options:[
      {val:'', txt:'Semua Target'},
      {val:'Semua', txt:'Semua'},
      {val:'Pelanggan', txt:'Pelanggan'},
      {val:'Sales', txt:'Sales'},
      {val:'Teknisi', txt:'Teknisi'}
    ]};
  }

  if (tableName === 'tutorials'){
    return { key:'kategori', label:'Filter Kategori', options:[
      {val:'', txt:'Semua Kategori'},
      {val:'Pelanggan', txt:'Pelanggan'},
      {val:'Sales', txt:'Sales'},
      {val:'Teknisi', txt:'Teknisi'}
    ]};
  }

  if (tableName === 'reports'){
    return { key:'jenis_laporan', label:'Filter Jenis', options:[
      {val:'', txt:'Semua Jenis'},
      {val:'Pemasukan', txt:'Pemasukan'},
      {val:'Pengeluaran', txt:'Pengeluaran'}
    ]};
  }

  if (tableName === 'packages'){
    return { key:'status_aktif', label:'Filter Status', options:[
      {val:'', txt:'Semua Status'},
      {val:'Aktif', txt:'Aktif'},
      {val:'Non-Aktif', txt:'Non-Aktif'}
    ]};
  }

  return null;
}

/* ===========================
   CRUD TABLE RENDER
=========================== */
function renderTable(tableName, title){
  if (tableName === 'customers') {
    renderCRUDTable('customers', 'Manajemen Pelanggan', [
      { key:'nama', label:'Nama' },
      { key:'telp', label:'WhatsApp' },
      { key:'alamat', label:'Alamat' },
      { key:'status', label:'Status', type:'badge' }
    ]);
  } else if (tableName === 'packages') {
    renderCRUDTable('packages', 'Manajemen Paket', [
      { key:'nama_paket', label:'Nama Paket' },
      { key:'harga', label:'Harga', type:'money' },
      { key:'bandwidth', label:'Bandwidth' },
      { key:'ketersediaan', label:'Ketersediaan', type:'badge' },
      { key:'status_aktif', label:'Status', type:'badge' }
    ]);
  } else if (tableName === 'locations') {
    renderCRUDTable('locations', 'Manajemen Lokasi / Blok', [
      { key:'nama_blok', label:'Nama Blok' },
      { key:'keterangan', label:'Keterangan' }
    ]);
  } else if (tableName === 'users') {
    renderCRUDTable('users', 'Manajemen User', [
      { key:'nama', label:'Nama' },
      { key:'username', label:'Username' },
      { key:'email', label:'Email' },
      { key:'role', label:'Role', type:'badge' }
    ]);
  } else if (tableName === 'tickets') {
    renderCRUDTable('tickets', 'Manajemen Tiket', [
      { key:'judul_laporan', label:'Judul' },
      { key:'status', label:'Status', type:'badge' },
      { key:'created_at', label:'Waktu' }
    ]);
  } else if (tableName === 'announcements') {
    renderCRUDTable('announcements', 'Pengumuman', [
      { key:'judul', label:'Judul' },
      { key:'target', label:'Target', type:'badge' },
      { key:'created_at', label:'Waktu' }
    ]);
  } else if (tableName === 'tutorials') {
    renderCRUDTable('tutorials', 'Tutorial', [
      { key:'judul', label:'Judul' },
      { key:'kategori', label:'Kategori', type:'badge' }
    ]);
  } else if (tableName === 'reports') {
    renderCRUDTable('reports', 'Laporan Keuangan', [
      { key:'jenis_laporan', label:'Jenis', type:'badge' },
      { key:'jumlah', label:'Nominal', type:'money' },
      { key:'keterangan', label:'Keterangan' },
      { key:'created_at', label:'Waktu' }
    ]);
  }
}

function renderCRUDTable(tableName, headerTitle, columns){
  globalTableConfig = { tableName: tableName, headerTitle: headerTitle, columns: columns };
  tableState = { search:'', filterStatus:'', sortKey:'', sortDir:'asc', extraKey:'', extraVal:'' };

  var extra = getExtraFilterConfig(tableName);
  var extraFilterHtml = '';
  if (extra){
    extraFilterHtml =
      '<select id="tableFilterExtra" class="border rounded-lg px-3 py-2 outline-none bg-white" title="' + escapeHtml(extra.label) + '">' +
        (extra.options||[]).map(function(o){
          return '<option value="' + escapeHtml(o.val) + '">' + escapeHtml(o.txt) + '</option>';
        }).join('') +
      '</select>';
  }

  document.getElementById('contentArea').innerHTML =
    '<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">' +
      '<div>' +
        '<h3 class="text-xl font-bold text-gray-800">' + escapeHtml(headerTitle) + '</h3>' +
        '<p class="text-sm text-gray-500">Kelola data ' + escapeHtml(tableName) + ' secara realtime.</p>' +
      '</div>' +
      '<div class="flex gap-2">' +
        (canAddRow(tableName)
          ? '<button onclick="openForm(\'' + tableName + '\')" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium flex items-center gap-2">' +
              '<i data-lucide="plus" class="w-4 h-4"></i> Tambah' +
            '</button>'
          : '') +
      '</div>' +
    '</div>' +

    '<div class="bg-white rounded-2xl shadow-sm border overflow-hidden">' +
      '<div class="p-4 border-b bg-gray-50 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">' +
        '<div class="flex-1">' +
          '<input id="tableSearch" placeholder="Cari..." class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">' +
        '</div>' +
        '<div class="flex gap-2 flex-wrap justify-end">' +
          (extraFilterHtml || '') +
          '<select id="tableFilterStatus" class="border rounded-lg px-3 py-2 outline-none bg-white" title="Filter Status">' +
            '<option value="">Semua Status</option>' +
            '<option value="Aktif">Aktif</option>' +
            '<option value="Antrian">Antrian</option>' +
            '<option value="Non-Aktif">Non-Aktif</option>' +
            '<option value="Open">Open</option>' +
            '<option value="Proses">Proses</option>' +
            '<option value="Selesai">Selesai</option>' +
            '<option value="Tersedia">Tersedia</option>' +
            '<option value="Tidak Tersedia">Tidak Tersedia</option>' +
          '</select>' +
          '<button onclick="loadTableData(\'' + tableName + '\')" class="px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800">Refresh</button>' +
        '</div>' +
      '</div>' +

      '<div class="overflow-x-auto">' +
        '<table class="min-w-full divide-y divide-gray-200">' +
          '<thead class="bg-gray-50">' +
            '<tr>' +
              columns.map(function(c){
                return '<th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider sortable" onclick="sortBy(\'' + c.key + '\')">' + escapeHtml(c.label) + '</th>';
              }).join('') +
              '<th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Aksi</th>' +
            '</tr>' +
          '</thead>' +
          '<tbody id="tableBody" class="bg-white divide-y divide-gray-100">' +
            '<tr><td colspan="' + (columns.length + 1) + '" class="p-8 text-center text-gray-400">Loading...</td></tr>' +
          '</tbody>' +
        '</table>' +
      '</div>' +

      '<div class="p-4 border-t bg-gray-50 flex items-center justify-between text-sm text-gray-600" id="tableFooter">' +
        '<span>Menampilkan 0 data</span>' +
      '</div>' +
    '</div>';

  lucide.createIcons();

  document.getElementById('tableSearch').addEventListener('input', function(e){
    tableState.search = (e.target.value || '').trim().toLowerCase();
    renderTableRows();
  });
  document.getElementById('tableFilterStatus').addEventListener('change', function(e){
    tableState.filterStatus = e.target.value;
    renderTableRows();
  });

  if (extra){
    tableState.extraKey = extra.key;
    var el = document.getElementById('tableFilterExtra');
    if (el){
      el.addEventListener('change', function(e){
        tableState.extraVal = e.target.value;
        renderTableRows();
      });
    }
  }

  loadTableData(tableName);
}

function sortBy(key){
  if (tableState.sortKey === key) tableState.sortDir = (tableState.sortDir === 'asc') ? 'desc' : 'asc';
  else { tableState.sortKey = key; tableState.sortDir = 'asc'; }
  renderTableRows();
}

/* ✅ PATCH: loadTableData aman walau server balikin object */
function loadTableData(tableName){
  startLoading('Memuat data...');

  if (isPreview){
    globalTableData = mockDB[tableName] || [];
    endLoading();
    renderTableRows();
    return;
  }

  runAuth('getSheetData', [tableName], function(res){
    globalTableData = normalizeSheetDataResponse(res);
    endLoading();
    renderTableRows();
  }, function(err){
    endLoading();
    Swal.fire('Error', 'Gagal load data: ' + err, 'error');
    globalTableData = [];
    renderTableRows();
  });
}

function renderTableRows(){
  var tbody = document.getElementById('tableBody');
  var footer = document.getElementById('tableFooter');
  if (!tbody) return;

  /* ✅ PATCH GUARD: cegah crash saat globalTableData bukan array / config belum siap */
  if (!Array.isArray(globalTableData)) globalTableData = [];
  if (!globalTableConfig || !globalTableConfig.columns) {
    tbody.innerHTML = '<tr><td class="p-8 text-center text-gray-400">Konfigurasi tabel belum siap.</td></tr>';
    return;
  }

  var filtered = (globalTableData || []).filter(function(item){
    if (tableState.filterStatus){
      var hit = false;
      ['status','status_aktif','ketersediaan'].forEach(function(k){
        if (String(item[k] || '') === String(tableState.filterStatus)) hit = true;
      });
      if (!hit) return false;
    }

    if (tableState.extraKey && tableState.extraVal){
      if (String(item[tableState.extraKey] || '') !== String(tableState.extraVal)) return false;
    }

    if (tableState.search){
      var found = false;
      Object.keys(item).forEach(function(k){
        if (found) return;
        var v = String(item[k] === undefined || item[k] === null ? '' : item[k]).toLowerCase();
        if (v.indexOf(tableState.search) !== -1) found = true;
      });
      return found;
    }
    return true;
  });

  if (tableState.sortKey){
    filtered.sort(function(a,b){
      var valA = a[tableState.sortKey] || '';
      var valB = b[tableState.sortKey] || '';
      if (typeof valA === 'string') valA = valA.toLowerCase();
      if (typeof valB === 'string') valB = valB.toLowerCase();
      if (valA < valB) return (tableState.sortDir === 'asc') ? -1 : 1;
      if (valA > valB) return (tableState.sortDir === 'asc') ? 1 : -1;
      return 0;
    });
  }

  if (filtered.length === 0){
    tbody.innerHTML = '<tr><td colspan="' + (globalTableConfig.columns.length + 1) + '" class="p-8 text-center text-gray-400">Data tidak ditemukan.</td></tr>';
    footer.innerHTML = '<span>Menampilkan <b>0</b> data</span>';
    return;
  }

  tbody.innerHTML = filtered.map(function(item){
    var tds = globalTableConfig.columns.map(function(col){
      var val = (item[col.key] === undefined || item[col.key] === null || item[col.key] === '') ? '-' : item[col.key];
      if (col.type === 'money') val = fmtMoney(val);
      if (col.type === 'badge') val = badge(val);
      return '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">' + val + '</td>';
    }).join('');

    var itemStr = JSON.stringify(item).replace(/"/g, '&quot;');

    var detailBtn = '';
    if (globalTableConfig.tableName === 'tickets') {
      detailBtn =
        '<button onclick="openTicketDetail(\'' + escapeHtml(item.id) + '\')" class="text-gray-600 hover:text-gray-900" title="Detail">' +
          '<i data-lucide="eye" class="w-4 h-4"></i>' +
        '</button>';
    } else {
      detailBtn =
        '<button onclick="showDetail(\'' + globalTableConfig.tableName + '\', ' + itemStr + ')" class="text-gray-600 hover:text-gray-900" title="Detail">' +
          '<i data-lucide="eye" class="w-4 h-4"></i>' +
        '</button>';
    }

    var editBtn = canEditRow(globalTableConfig.tableName, item)
      ? '<button onclick="openForm(\'' + globalTableConfig.tableName + '\', ' + itemStr + ')" class="text-blue-600 hover:text-blue-900" title="Edit">' +
          '<i data-lucide="edit-2" class="w-4 h-4"></i>' +
        '</button>'
      : '';

    var delBtn = canDeleteRow(globalTableConfig.tableName, item)
      ? '<button onclick="confirmDelete(\'' + globalTableConfig.tableName + '\', \'' + escapeHtml(item.id) + '\')" class="text-red-600 hover:text-red-900" title="Hapus">' +
          '<i data-lucide="trash-2" class="w-4 h-4"></i>' +
        '</button>'
      : '';

    var actions =
      '<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end gap-3">' +
        detailBtn + editBtn + delBtn +
      '</td>';

    return '<tr class="hover:bg-gray-50 transition-colors border-b last:border-0">' + tds + actions + '</tr>';
  }).join('');

  footer.innerHTML = '<span>Menampilkan <b>' + filtered.length + '</b> dari <b>' + globalTableData.length + '</b> data</span>';
  lucide.createIcons();
}

/* ===========================
   DETAIL POPUP (icon eye)
=========================== */
function showDetail(tableName, item){
  try {
    var html = '';

    if (tableName === 'customers'){
      var paket = getById(refData.packages, item.paket_id);
      var lokasi = getById(refData.locations, item.lokasi_id);
      var sales = getById(refData.sales, item.sales_id) || getById(mockDB.users, item.sales_id);

      var lat = item.lat || '';
      var lng = item.lng || '';
      var mapsLink = (lat && lng) ? ('https://www.google.com/maps?q=' + encodeURIComponent(lat + ',' + lng)) : '';

      html =
        '<div class="text-left">' +
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">' +
            '<div><div class="text-xs text-gray-500">Nama</div><div class="font-semibold">' + escapeHtml(item.nama) + '</div></div>' +
            '<div><div class="text-xs text-gray-500">WhatsApp</div><div class="font-semibold">' + escapeHtml(item.telp) + '</div></div>' +
            '<div class="md:col-span-2"><div class="text-xs text-gray-500">Alamat</div><div class="font-semibold">' + escapeHtml(item.alamat) + '</div></div>' +

            '<div><div class="text-xs text-gray-500">Status</div><div>' + badge(item.status) + '</div></div>' +
            '<div><div class="text-xs text-gray-500">Paket</div><div class="font-semibold">' + escapeHtml(paket ? paket.nama_paket : (item.paket_id||'-')) + '</div></div>' +
            '<div><div class="text-xs text-gray-500">Lokasi/Blok</div><div class="font-semibold">' + escapeHtml(lokasi ? lokasi.nama_blok : (item.lokasi_id||'-')) + '</div></div>' +
            '<div><div class="text-xs text-gray-500">Sales</div><div class="font-semibold">' + escapeHtml(sales ? sales.nama : (item.sales_id||'-')) + '</div></div>' +

            '<div><div class="text-xs text-gray-500">Koordinat</div><div class="font-semibold">' + escapeHtml((lat && lng) ? (lat + ', ' + lng) : '-') + '</div>' +
              (mapsLink ? '<a class="text-blue-600 text-xs hover:underline" target="_blank" href="' + mapsLink + '">Buka di Google Maps</a>' : '') +
            '</div>' +
            '<div><div class="text-xs text-gray-500">No Internet</div><div class="font-semibold">' + escapeHtml(item.username || '-') + '</div></div>' +
            '<div><div class="text-xs text-gray-500">Created</div><div class="font-semibold">' + escapeHtml(item.created_at || '-') + '</div></div>' +
            '<div class="md:col-span-2"><div class="text-xs text-gray-500">Catatan Tambahan</div><div class="font-semibold">' + escapeHtml(item.catatan || '-') + '</div></div>' +
          '</div>' +

          '<div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">' +
            '<div class="p-3 border rounded-xl">' +
              '<div class="text-xs text-gray-500 mb-1">Foto KTP</div>' +
              (item.foto_ktp ? '<a target="_blank" class="text-blue-600 hover:underline text-sm" href="' + escapeHtml(item.foto_ktp) + '">Lihat Foto</a>' : '<div class="text-sm text-gray-400">-</div>') +
            '</div>' +
            '<div class="p-3 border rounded-xl">' +
              '<div class="text-xs text-gray-500 mb-1">Foto Rumah</div>' +
              (item.foto_rumah ? '<a target="_blank" class="text-blue-600 hover:underline text-sm" href="' + escapeHtml(item.foto_rumah) + '">Lihat Foto</a>' : '<div class="text-sm text-gray-400">-</div>') +
            '</div>' +
          '</div>' +
        '</div>';
    }
    else {
      var rows = Object.keys(item || {}).map(function(k){
        var v = item[k];
        if (k === 'password') v = '••••••';
        return '<tr><td class="pr-3 py-1 text-xs text-gray-500">' + escapeHtml(k) + '</td><td class="py-1 text-sm text-gray-800 font-medium">' + escapeHtml(v) + '</td></tr>';
      }).join('');

      html =
        '<div class="text-left">' +
          '<div class="border rounded-xl p-3 overflow-auto max-h-[60vh]">' +
            '<table class="w-full">' + rows + '</table>' +
          '</div>' +
        '</div>';
    }

    Swal.fire({
      title: 'Detail',
      html: html,
      width: 860,
      showCloseButton: true,
      confirmButtonText: 'Tutup'
    });
    lucide.createIcons();
  } catch (e) {
    Swal.fire('Error', 'Gagal tampilkan detail: ' + e, 'error');
  }
}

/* ===========================
   DYNAMIC FORM
=========================== */
function openForm(tableName, item){
  currentEditId = item ? item.id : null;
  document.getElementById('modalTitle').textContent = item ? ('Edit ' + tableName) : ('Tambah ' + tableName);

  var form = document.getElementById('dynamicForm');
  form.innerHTML = '';
  form.dataset.table = tableName;

  var fields = [];

  /* =========================================================
     ✅ PERBAIKAN DI SINI (CUSTOMERS): Sales tidak pilih Sales
     - Admin: dropdown Sales tampil
     - Sales: sales_id otomatis = currentUser.id (hidden)
  ========================================================== */
  if (tableName === 'customers'){
    fields = [
      { name:'nama', label:'Nama Lengkap', type:'text', req:true },
      { name:'telp', label:'WhatsApp', type:'text', req:true },
      { name:'alamat', label:'Alamat', type:'textarea', req:true },
      { type:'coords', label:'Koordinat (Lat, Lng)', latName:'lat', lngName:'lng' },

      { name:'lokasi_id', label:'Lokasi (Blok)', type:'select',
        options:(refData.locations||[]).map(function(l){return {val:l.id, txt:l.nama_blok};}) },

      { name:'paket_id', label:'Paket', type:'select',
        options:(refData.packages||[]).map(function(p){return {val:p.id, txt:(p.nama_paket + ' - ' + p.harga)};}) },

      { name:'catatan', label:'Catatan Tambahan', type:'textarea', req:false },

      { name:'foto_ktp', label:'Foto KTP', type:'file', req:true },
      { name:'foto_rumah', label:'Foto Rumah', type:'file', req:true }
    ];

    if (currentUser.role === 'Admin'){
      // Admin boleh pilih sales
      fields.push(
        { name:'sales_id', label:'Sales', type:'select', req:true,
          options:(refData.sales||[]).map(function(s){return {val:s.id, txt:s.nama};}) }
      );

      fields.push(
        { name:'username', label:'Nomor Internet', type:'text', req:true },
        { name:'password', label:'Password', type:'text', req:true },
        { name:'status', label:'Status', type:'select', options:[
          {val:'Antrian', txt:'Antrian (Belum Aktif)'},
          {val:'Aktif', txt:'Aktif'},
          {val:'Non-Aktif', txt:'Non-Aktif'}
        ]}
      );
    } else if (currentUser.role === 'Sales'){
      // Sales: otomatis rekrutan sales yang login (tanpa dropdown)
      fields.push({ name:'sales_id', type:'hidden', value:(currentUser && currentUser.id) ? currentUser.id : '' });
      fields.push({ name:'status', type:'hidden', value:'Antrian' });
    }
  }
  /* =======================
     BAGIAN LAIN TETAP
  ======================== */
  else if (tableName === 'tickets'){
    if (currentUser.role === 'Admin'){
      fields = [
        { name:'judul_laporan', label:'Kendala / Masalah', type:'text', req:true },
        { name:'pelanggan_id', label:'Pelanggan (Opsional)', type:'select',
          options:[{val:'',txt:'- Pilih -'}].concat((refData.customers||[]).map(function(c){return {val:c.id, txt:c.nama};})) },
        { name:'teknisi_id', label:'Assign Teknisi', type:'select',
          options:[{val:'',txt:'- Pilih -'}].concat((refData.teknisi||[]).map(function(t){return {val:t.id, txt:t.nama};})) },
        { name:'status', label:'Status', type:'select', options:[
          {val:'Open', txt:'Open'},
          {val:'Proses', txt:'Proses'},
          {val:'Selesai', txt:'Selesai'}
        ]},
        { name:'keterangan_teknisi', label:'Catatan Teknisi', type:'textarea' }
      ];
    }
    else if (currentUser.role === 'Teknisi'){
      if (!item) {
        Swal.fire('Info', 'Teknisi tidak bisa membuat tiket baru.', 'info');
        return;
      }
      fields = [
        { name:'judul_laporan', label:'Judul (tidak bisa diubah)', type:'text', req:false },
        { name:'status', label:'Status', type:'select', options:[
          {val:'Open', txt:'Open'},
          {val:'Proses', txt:'Proses'},
          {val:'Selesai', txt:'Selesai'}
        ]},
        { name:'keterangan_teknisi', label:'Catatan Teknisi', type:'textarea' }
      ];
    }
    else if (currentUser.role === 'Pelanggan'){
      fields = [
        { name:'judul_laporan', label:'Kendala / Masalah', type:'text', req:true }
      ];
    } else {
      fields = [
        { name:'judul_laporan', label:'Kendala / Masalah', type:'text', req:true }
      ];
    }
  }
  else if (tableName === 'announcements'){
    fields = [
      { name:'judul', label:'Judul Pengumuman', type:'text', req:true },
      { name:'target', label:'Target', type:'select', options:[
        {val:'Semua', txt:'Semua'},
        {val:'Pelanggan', txt:'Pelanggan'},
        {val:'Sales', txt:'Sales'},
        {val:'Teknisi', txt:'Teknisi'}
      ]},
      { name:'isi', label:'Isi Pengumuman', type:'textarea', req:true }
    ];
  }
  else if (tableName === 'tutorials'){
    fields = [
      { name:'judul', label:'Judul Tutorial', type:'text', req:true },
      { name:'kategori', label:'Kategori', type:'select', options:[
        {val:'Pelanggan', txt:'Pelanggan'},
        {val:'Teknisi', txt:'Teknisi'},
        {val:'Sales', txt:'Sales'}
      ]},
      { name:'link_isi', label:'Link Video / Isi Teks', type:'textarea', req:true }
    ];
  }
  else if (tableName === 'reports'){
    fields = [
      { name:'jenis_laporan', label:'Jenis Laporan', type:'select', options:[
        {val:'Pemasukan', txt:'Pemasukan'},
        {val:'Pengeluaran', txt:'Pengeluaran'}
      ]},
      { name:'jumlah', label:'Nominal (Angka)', type:'number', req:true },
      { name:'keterangan', label:'Keterangan Transaksi', type:'textarea', req:true }
    ];
  }
  else if (tableName === 'packages'){
    fields = [
      { name:'nama_paket', label:'Nama Paket', type:'text', req:true },
      { name:'harga', label:'Harga (Rp)', type:'number', req:true },
      { name:'bandwidth', label:'Bandwidth', type:'text', req:true, placeholder:'Contoh: 10 Mbps' },
      { name:'status_aktif', label:'Status Paket', type:'select', options:[
        {val:'Aktif', txt:'Aktif'},
        {val:'Non-Aktif', txt:'Non-Aktif'}
      ]},
      { name:'ketersediaan', label:'Ketersediaan Pendaftaran', type:'select', options:[
        {val:'Tersedia', txt:'Tersedia (Bisa Daftar Baru)'},
        {val:'Tidak Tersedia', txt:'Tidak Tersedia (Khusus Lama)'}
      ]}
    ];
  }
  else if (tableName === 'locations'){
    fields = [
      { name:'nama_blok', label:'Nama Blok', type:'text', req:true },
      { name:'keterangan', label:'Keterangan', type:'text' }
    ];
  }
  else if (tableName === 'users'){
    fields = [
      { name:'nama', label:'Nama Lengkap', type:'text', req:true },
      { name:'username', label:'Username', type:'text', req:true },
      { name:'password', label:'Password', type:'text', req:true },
      { name:'email', label:'Email Google', type:'email', req:true, placeholder:'Contoh: nama@gmail.com' },
      { name:'role', label:'Role', type:'select', options:[
        {val:'Admin', txt:'Admin'},
        {val:'Teknisi', txt:'Teknisi'},
        {val:'Sales', txt:'Sales'}
      ]},
      { name:'telp', label:'No HP', type:'text', req:true }
    ];
  }

  fields.forEach(function(f){
    if (f.type === 'hidden'){
      var hid = document.createElement('input');
      hid.type = 'hidden';
      hid.name = f.name;
      hid.value = item ? (item[f.name] || '') : (f.value || '');
      form.appendChild(hid);
      return;
    }

    var inputHtml = '';
    var val = item ? (item[f.name] || '') : '';

    if (f.type === 'coords'){
      var latVal = item ? (item[f.latName] || '') : '';
      var lngVal = item ? (item[f.lngName] || '') : '';
      inputHtml =
        '<div class="grid grid-cols-1 md:grid-cols-12 gap-2">' +
          '<div class="md:col-span-5">' +
            '<input type="text" name="' + f.latName + '" value="' + escapeHtml(latVal) + '" readonly placeholder="-6.200000" class="w-full border rounded-lg px-3 py-2 outline-none bg-gray-50 focus:ring-2 focus:ring-blue-500">' +
            '<p class="text-xs text-gray-400 mt-1">Latitude</p>' +
          '</div>' +
          '<div class="md:col-span-5">' +
            '<input type="text" name="' + f.lngName + '" value="' + escapeHtml(lngVal) + '" readonly placeholder="106.816666" class="w-full border rounded-lg px-3 py-2 outline-none bg-gray-50 focus:ring-2 focus:ring-blue-500">' +
            '<p class="text-xs text-gray-400 mt-1">Longitude</p>' +
          '</div>' +
          '<div class="md:col-span-2 flex md:block">' +
            '<button type="button" onclick="openMapPicker(\'' + f.latName + '\',\'' + f.lngName + '\')" class="w-full px-4 py-2 rounded-lg border border-blue-600 text-blue-700 hover:bg-blue-50 font-medium">Pilih</button>' +
          '</div>' +
        '</div>' +
        '<p class="text-xs text-gray-500 mt-2">Pilih koordinat dari peta satelit untuk memudahkan mapping pelanggan.</p>';
    }
    else if (f.type === 'select'){
      var opts = (f.options || []).map(function(o){
        var sel = (String(val) === String(o.val)) ? ' selected' : '';
        return '<option value="' + escapeHtml(o.val) + '"' + sel + '>' + escapeHtml(o.txt) + '</option>';
      }).join('');
      inputHtml = '<select name="' + f.name + '" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white">' + opts + '</select>';
    }
    else if (f.type === 'textarea'){
      inputHtml = '<textarea name="' + f.name + '" rows="3" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"' + (f.req ? ' required' : '') + '>' + escapeHtml(val) + '</textarea>';
    }
    else if (f.type === 'file'){
      inputHtml = '<input type="file" name="' + f.name + '" accept="image/*" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"' + ((!item && f.req) ? ' required' : '') + '>';
      if (item && item[f.name]){
        inputHtml += '<div class="mt-1 text-xs text-gray-500">File saat ini: <a href="' + escapeHtml(item[f.name]) + '" target="_blank" class="text-blue-600 hover:underline">Lihat Foto</a></div>';
      }
    }
    else {
      inputHtml = '<input type="' + f.type + '" name="' + f.name + '" value="' + escapeHtml(val) + '" placeholder="' + escapeHtml(f.placeholder || '') + '" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"' + (f.req ? ' required' : '') + '>';
    }

    var div = document.createElement('div');
    div.innerHTML = '<label class="block text-sm font-medium text-gray-700 mb-1">' + escapeHtml(f.label) + '</label>' + inputHtml;
    form.appendChild(div);
  });

  document.getElementById('modalForm').classList.remove('hidden');
}

function closeModal(){
  document.getElementById('modalForm').classList.add('hidden');
}

/* ===========================
   MAP PICKER (SATELLITE)
=========================== */
var mapPicker = null;
var mapMarker = null;
var mapPicked = { lat:null, lng:null };
var targetLatName = null;
var targetLngName = null;

function openMapPicker(latName, lngName){
  targetLatName = latName;
  targetLngName = lngName;

  document.getElementById('mapPickerModal').classList.remove('hidden');

  setTimeout(function(){
    if (!mapPicker) initMapPicker();

    var form = document.getElementById('dynamicForm');
    var latEl = form.querySelector('[name="' + latName + '"]');
    var lngEl = form.querySelector('[name="' + lngName + '"]');
    var lat = latEl && latEl.value ? parseFloat(latEl.value) : NaN;
    var lng = lngEl && lngEl.value ? parseFloat(lngEl.value) : NaN;

    if (!isNaN(lat) && !isNaN(lng)) setMapPicked(lat, lng, true);
    else useMyLocation(true);

    mapPicker.invalidateSize();
    lucide.createIcons();
  }, 200);
}

function closeMapPicker(){
  document.getElementById('mapPickerModal').classList.add('hidden');
}

function initMapPicker(){
  mapPicker = L.map('mapPicker', { zoomControl:true }).setView([-6.200000, 106.816666], 14);

  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19,
    attribution: 'Tiles © Esri'
  }).addTo(mapPicker);

  mapMarker = L.marker(mapPicker.getCenter(), { draggable:true }).addTo(mapPicker);

  mapMarker.on('dragend', function(){
    var p = mapMarker.getLatLng();
    setMapPicked(p.lat, p.lng, false);
  });

  mapPicker.on('click', function(e){
    setMapPicked(e.latlng.lat, e.latlng.lng, true);
  });

  var c = mapPicker.getCenter();
  setMapPicked(c.lat, c.lng, false);
}

function setMapPicked(lat, lng, pan){
  mapPicked.lat = lat;
  mapPicked.lng = lng;

  var ll = L.latLng(lat, lng);
  if (mapMarker) mapMarker.setLatLng(ll);
  if (pan && mapPicker) mapPicker.setView(ll, Math.max(mapPicker.getZoom(), 16));

  document.getElementById('mapPickedText').textContent = lat.toFixed(6) + ', ' + lng.toFixed(6);

  var g = document.getElementById('mapOpenGmaps');
  g.href = 'https://www.google.com/maps?q=' + lat + ',' + lng;
  g.classList.remove('hidden');
}

function applyPickedCoords(){
  var form = document.getElementById('dynamicForm');
  if (!form || mapPicked.lat == null || mapPicked.lng == null) return;

  var latEl = form.querySelector('[name="' + targetLatName + '"]');
  var lngEl = form.querySelector('[name="' + targetLngName + '"]');
  if (latEl) latEl.value = mapPicked.lat.toFixed(6);
  if (lngEl) lngEl.value = mapPicked.lng.toFixed(6);

  closeMapPicker();
}

async function searchOnMap(){
  var q = (document.getElementById('mapSearchInput').value || '').trim();
  if (!q) return;

  try {
    var url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q);
    var res = await fetch(url, { headers: { 'Accept-Language': 'id' } });
    var data = await res.json();
    if (!data || !data.length) {
      Swal.fire('Tidak ditemukan', 'Coba kata kunci lain (misal: nama desa + kecamatan).', 'info');
      return;
    }
    var lat = parseFloat(data[0].lat);
    var lon = parseFloat(data[0].lon);
    setMapPicked(lat, lon, true);
  } catch (e) {
    Swal.fire('Error', 'Gagal mencari lokasi: ' + e, 'error');
  }
}

function useMyLocation(silent){
  if (!navigator.geolocation){
    if (!silent) Swal.fire('Tidak didukung', 'Browser tidak mendukung geolocation.', 'info');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    function(pos){
      setMapPicked(pos.coords.latitude, pos.coords.longitude, true);
    },
    function(err){
      if (!silent) Swal.fire('Gagal', 'Tidak bisa mengambil lokasi: ' + err.message, 'info');
      setMapPicked(-6.200000, 106.816666, true);
    },
    { enableHighAccuracy:true, timeout:8000 }
  );
}

/* ===========================
   FILE HANDLING
=========================== */
function readFile(file){
  return new Promise(function(resolve, reject){
    var reader = new FileReader();
    reader.onload = function(){
      var base64 = String(reader.result).split(',')[1];
      resolve({ isFile:true, name:file.name, mimeType:file.type, data:base64 });
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ===========================
   SUBMIT FORM (CRUD)
=========================== */
async function handleFormSubmit(e){
  e.preventDefault();
  var form = e.target;
  var tableName = form.dataset.table;
  var formData = new FormData(form);
  var dataObj = {};

  startLoading('Membaca data & upload...');

  for (var pair of formData.entries()){
    var key = pair[0];
    var value = pair[1];

    if (value instanceof File && value.size > 0){
      try { dataObj[key] = await readFile(value); }
      catch (err){
        endLoading();
        Swal.fire('Error', 'Gagal membaca file: ' + err, 'error');
        return;
      }
    } else {
      dataObj[key] = value;
    }
  }

  if (isPreview){
    if (currentEditId){
      var idx = (mockDB[tableName] || []).findIndex(function(x){return x.id === currentEditId;});
      if (idx >= 0) mockDB[tableName][idx] = Object.assign({}, mockDB[tableName][idx], dataObj);
    } else {
      dataObj.id = 'id_' + Math.random().toString(36).slice(2,8);
      mockDB[tableName] = mockDB[tableName] || [];
      mockDB[tableName].push(dataObj);
    }
    endLoading();
    closeModal();
    Swal.fire('Sukses', 'Data tersimpan (Preview).', 'success');
    loadReferenceData(function(){
      loadTableData(tableName);
      refreshDashboardStats();
    });
    return;
  }

  if (currentEditId){
    runAuth('updateData', [tableName, currentEditId, dataObj], function(res){
      endLoading();
      if (res && res.success){
        closeModal();
        Swal.fire('Sukses', 'Data berhasil diupdate!', 'success');
        loadReferenceData(function(){
          loadTableData(tableName);
          refreshDashboardStats();
        });
      } else {
        Swal.fire('Gagal', (res && res.message) ? res.message : 'Gagal update', 'error');
      }
    }, function(err){
      endLoading();
      Swal.fire('Error', String(err), 'error');
    });
  } else {
    runAuth('saveData', [tableName, dataObj], function(res){
      endLoading();
      if (res && res.success){
        closeModal();
        Swal.fire('Sukses', 'Data berhasil ditambahkan!', 'success');
        loadReferenceData(function(){
          loadTableData(tableName);
          refreshDashboardStats();
        });
      } else {
        Swal.fire('Gagal', (res && res.message) ? res.message : 'Gagal simpan', 'error');
      }
    }, function(err){
      endLoading();
      Swal.fire('Error', String(err), 'error');
    });
  }
}

/* ===========================
   DELETE
=========================== */
function confirmDelete(tableName, id){
  Swal.fire({
    title: 'Hapus data?',
    text: 'Data yang dihapus tidak bisa dikembalikan.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, hapus',
    cancelButtonText: 'Batal'
  }).then(function(res){
    if (res.isConfirmed) doDelete(tableName, id);
  });
}

function doDelete(tableName, id){
  startLoading('Menghapus data...');

  if (isPreview){
    mockDB[tableName] = (mockDB[tableName] || []).filter(function(x){return x.id !== id;});
    endLoading();
    Swal.fire('Sukses', 'Data terhapus (Preview).', 'success');
    loadReferenceData(function(){
      loadTableData(tableName);
      refreshDashboardStats();
    });
    return;
  }

  runAuth('deleteData', [tableName, id], function(res){
    endLoading();
    if (res && res.success){
      Swal.fire('Sukses', 'Data berhasil dihapus!', 'success');
      loadReferenceData(function(){
        loadTableData(tableName);
        refreshDashboardStats();
      });
    } else {
      Swal.fire('Gagal', (res && res.message) ? res.message : 'Gagal hapus', 'error');
    }
  }, function(err){
    endLoading();
    Swal.fire('Error', String(err), 'error');
  });
}

/* =========================================================
   PATCH F: TICKET DETAIL + TIMELINE + CHAT + STATUS + ASSIGN
========================================================= */
var _ticketDetailId = null;

function openTicketDetail(ticketId){
  _ticketDetailId = ticketId;

  startLoading('Memuat detail tiket...');

  if (isPreview){
    var t = (mockDB.tickets || []).find(function(x){ return x.id === ticketId; }) || {id:ticketId, judul_laporan:'(Preview)', status:'Open', created_at:'-'};
    var logs = (mockDB.ticket_logs || []).filter(function(l){ return l.ticket_id === ticketId; });
    endLoading();
    renderTicketDetail(t, logs);
    return;
  }

  runAuth('getTicketDetail', [ticketId], function(res){
    endLoading();
    if (!res || !res.success){
      Swal.fire('Gagal', (res && res.message) ? res.message : 'Tidak bisa memuat tiket', 'error');
      return;
    }
    renderTicketDetail(res.ticket, res.logs || []);
  }, function(err){
    endLoading();
    Swal.fire('Error', String(err), 'error');
  });
}

function backToTickets(){
  renderTable('tickets', 'Tiket');
}

function renderTicketDetail(ticket, logs){
  var teknisiName = '-';
  if (ticket.teknisi_id){
    var tek = (refData.teknisi || []).find(function(x){ return String(x.id) === String(ticket.teknisi_id); });
    teknisiName = tek ? tek.nama : ticket.teknisi_id;
  }

  var pelangganName = '-';
  if (ticket.pelanggan_id){
    var c = (refData.customers || []).find(function(x){ return String(x.id) === String(ticket.pelanggan_id); });
    pelangganName = c ? c.nama : ticket.pelanggan_id;
  }

  var logsHtml = '';
  if (!logs || logs.length === 0){
    logsHtml = '<div class="text-sm text-gray-400">Belum ada aktivitas.</div>';
  } else {
    logsHtml = logs.map(function(l){
      var mine = (String(l.actor_id || '') === String(currentUser.id || ''));
      var box = mine ? 'bg-blue-50 border-blue-100' : 'bg-gray-50 border-gray-100';
      var role = l.actor_role ? ('<span class="text-xs font-bold text-gray-500">[' + escapeHtml(l.actor_role) + ']</span>') : '';
      var attach = l.attachment
        ? '<div class="mt-2"><a class="text-xs text-blue-600 hover:underline" target="_blank" href="' + escapeHtml(l.attachment) + '">Lihat Lampiran</a></div>'
        : '';
      return '' +
        '<div class="border ' + box + ' rounded-xl p-3">' +
          '<div class="flex items-center justify-between gap-2">' +
            '<div class="text-sm font-semibold text-gray-800">' + escapeHtml(l.actor_name || '-') + ' ' + role + '</div>' +
            '<div class="text-xs text-gray-400">' + escapeHtml(l.created_at || '-') + '</div>' +
          '</div>' +
          '<div class="text-sm text-gray-700 mt-1 whitespace-pre-wrap">' + escapeHtml(l.message || '') + '</div>' +
          attach +
        '</div>';
    }).join('<div class="h-2"></div>');
  }

  var canStatus = (currentUser.role === 'Admin' || currentUser.role === 'Teknisi');
  var canAssign = (currentUser.role === 'Admin');

  var statusBlock = canStatus ? (`
    <div class="mt-4 border rounded-2xl p-4 bg-white">
      <div class="font-bold text-gray-800 mb-2">Aksi Teknisi/Admin</div>
      <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
        <div class="md:col-span-4">
          <label class="text-xs text-gray-500">Status</label>
          <select id="ticketStatusSel" class="w-full border rounded-lg px-3 py-2 outline-none bg-white">
            <option value="Open" ${ticket.status==='Open'?'selected':''}>Open</option>
            <option value="Proses" ${ticket.status==='Proses'?'selected':''}>Proses</option>
            <option value="Selesai" ${ticket.status==='Selesai'?'selected':''}>Selesai</option>
          </select>
        </div>
        <div class="md:col-span-6">
          <label class="text-xs text-gray-500">Catatan (opsional)</label>
          <input id="ticketStatusNote" class="w-full border rounded-lg px-3 py-2 outline-none" placeholder="Contoh: sudah dicek, ganti kabel...">
        </div>
        <div class="md:col-span-2 flex items-end">
          <button onclick="updateTicketStatusUI('${escapeHtml(ticket.id)}')" class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">Update</button>
        </div>
      </div>
    </div>
  `) : '';

  var assignBlock = canAssign ? (`
    <div class="mt-3 border rounded-2xl p-4 bg-white">
      <div class="font-bold text-gray-800 mb-2">Assign Teknisi (Admin)</div>
      <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
        <div class="md:col-span-10">
          <select id="ticketAssignSel" class="w-full border rounded-lg px-3 py-2 outline-none bg-white">
            <option value="">- (kosong) -</option>
            ${(refData.teknisi||[]).map(function(t){
              var sel = String(t.id)===String(ticket.teknisi_id) ? 'selected' : '';
              return '<option value="'+escapeHtml(t.id)+'" '+sel+'>'+escapeHtml(t.nama)+'</option>';
            }).join('')}
          </select>
        </div>
        <div class="md:col-span-2">
          <button onclick="assignTicketUI('${escapeHtml(ticket.id)}')" class="w-full px-4 py-2 rounded-lg bg-gray-800 text-white hover:bg-gray-900 font-medium">Assign</button>
        </div>
      </div>
    </div>
  `) : '';

  document.getElementById('contentArea').innerHTML = `
    <div class="flex items-center justify-between gap-3 mb-4">
      <div>
        <h3 class="text-xl font-bold text-gray-800">Detail Tiket</h3>
        <p class="text-sm text-gray-500">Timeline aktivitas & komunikasi.</p>
      </div>
      <button onclick="backToTickets()" class="px-4 py-2 rounded-lg border hover:bg-gray-50">← Kembali</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
      <div class="md:col-span-4 bg-white border rounded-2xl p-5">
        <div class="text-xs text-gray-500">Judul</div>
        <div class="font-bold text-gray-800 mt-1">${escapeHtml(ticket.judul_laporan || '-')}</div>

        <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
          <div>
            <div class="text-xs text-gray-500">Status</div>
            <div class="mt-1">${badge(ticket.status)}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Dibuat</div>
            <div class="mt-1 font-semibold text-gray-800">${escapeHtml(ticket.created_at || '-')}</div>
          </div>
          <div class="col-span-2">
            <div class="text-xs text-gray-500">Pelanggan</div>
            <div class="mt-1 font-semibold text-gray-800">${escapeHtml(pelangganName)}</div>
          </div>
          <div class="col-span-2">
            <div class="text-xs text-gray-500">Teknisi</div>
            <div class="mt-1 font-semibold text-gray-800">${escapeHtml(teknisiName)}</div>
          </div>
        </div>

        ${assignBlock}
        ${statusBlock}
      </div>

      <div class="md:col-span-8 space-y-4">
        <div class="bg-white border rounded-2xl p-5">
          <div class="font-bold text-gray-800 mb-3">Timeline</div>
          <div class="space-y-2">${logsHtml}</div>
        </div>

        <div class="bg-white border rounded-2xl p-5">
          <div class="font-bold text-gray-800 mb-2">Kirim Pesan / Lampiran</div>
          <textarea id="ticketMsg" rows="3" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tulis update..."></textarea>
          <div class="flex flex-col md:flex-row gap-2 mt-2 items-center">
            <input id="ticketFile" type="file" class="w-full border rounded-lg px-3 py-2" />
            <button onclick="sendTicketMessage('${escapeHtml(ticket.id)}')" class="w-full md:w-auto px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">Kirim</button>
          </div>
        </div>
      </div>
    </div>
  `;
  lucide.createIcons();
}

async function sendTicketMessage(ticketId){
  var msg = (document.getElementById('ticketMsg').value || '').trim();
  var fileEl = document.getElementById('ticketFile');
  var file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;

  if (!msg && !file){
    Swal.fire('Info', 'Pesan atau lampiran wajib diisi.', 'info');
    return;
  }

  startLoading('Mengirim pesan...');

  try {
    var payload = { message: msg };
    if (file && file.size > 0){
      payload.attachment = await readFile(file);
    }

    runAuth('addTicketMessage', [ticketId, payload], function(res){
      endLoading();
      if (res && res.success){
        document.getElementById('ticketMsg').value = '';
        if (fileEl) fileEl.value = '';
        openTicketDetail(ticketId);
      } else {
        Swal.fire('Gagal', (res && res.message) ? res.message : 'Gagal kirim', 'error');
      }
    }, function(err){
      endLoading();
      Swal.fire('Error', String(err), 'error');
    });
  } catch(e){
    endLoading();
    Swal.fire('Error', String(e), 'error');
  }
}

function updateTicketStatusUI(ticketId){
  var status = document.getElementById('ticketStatusSel').value;
  var note = (document.getElementById('ticketStatusNote').value || '').trim();

  startLoading('Update status...');
  runAuth('updateTicketStatus', [ticketId, status, note], function(res){
    endLoading();
    if (res && res.success){
      openTicketDetail(ticketId);
    } else {
      Swal.fire('Gagal', (res && res.message) ? res.message : 'Gagal update status', 'error');
    }
  }, function(err){
    endLoading();
    Swal.fire('Error', String(err), 'error');
  });
}

function assignTicketUI(ticketId){
  var teknisiId = document.getElementById('ticketAssignSel').value;

  startLoading('Assign teknisi...');
  runAuth('assignTicketTechnician', [ticketId, teknisiId], function(res){
    endLoading();
    if (res && res.success){
      openTicketDetail(ticketId);
    } else {
      Swal.fire('Gagal', (res && res.message) ? res.message : 'Gagal assign', 'error');
    }
  }, function(err){
    endLoading();
    Swal.fire('Error', String(err), 'error');
  });
}
</script>

</body>
</html>
